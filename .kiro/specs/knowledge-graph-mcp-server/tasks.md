# 구현 계획: Knowledge Graph MCP Server

## 개요

TypeScript로 MCP 서버를 구현하여 지식 그래프를 관리합니다. 프로젝트는 엔티티 관리, 관계 추적, 관찰 시스템, 검색 기능, 영속성 저장을 포함합니다.

## 태스크

- [x] 1. 프로젝트 구조 및 기본 설정
  - TypeScript 프로젝트 초기화 (package.json, tsconfig.json)
  - MCP SDK 의존성 설치 (@modelcontextprotocol/sdk)
  - 디렉토리 구조 생성 (src/, tests/)
  - 테스트 프레임워크 설정 (Vitest, fast-check)
  - npx 실행을 위한 bin 설정
  - 요구사항: 6.5

- [x] 2. 데이터 모델 및 타입 정의
  - [x] 2.1 핵심 타입 정의
    - Entity, Relation, KnowledgeGraph 인터페이스 작성
    - EntityInput, RelationInput 타입 정의
    - Result 타입 및 에러 응답 타입 정의
    - 요구사항: 1.1, 2.1, 3.1

  - [x] 2.2 데이터 모델 속성 테스트 작성
    - 속성 1: 엔티티 생성 및 조회
    - 검증 대상: Requirements 1.1, 1.2

- [x] 3. 저장소 계층 구현
  - [x] 3.1 GraphStorage 클래스 구현
    - JSON 파일 읽기/쓰기 기능
    - 저장 경로 결정 로직 (.kiro 디렉토리 또는 홈 디렉토리)
    - 그래프 직렬화/역직렬화
    - 요구사항: 5.1, 5.2, 5.5, 5.6, 5.7

  - [x] 3.2 저장소 속성 테스트 작성
    - 속성 12: 영속성 라운드 트립
    - 검증 대상: Requirements 5.5

  - [x] 3.3 저장소 단위 테스트 작성
    - 빈 그래프 초기화 테스트
    - 손상된 JSON 파일 처리 테스트
    - 요구사항: 5.3, 5.4

- [x] 4. 지식 그래프 관리자 구현
  - [x] 4.1 KnowledgeGraphManager 클래스 기본 구조
    - 그래프 상태 관리 (entities Map, relations 배열)
    - 저장소 연동
    - 요구사항: 1.1, 2.1

  - [x] 4.2 엔티티 작업 구현
    - createEntities 메서드 (중복 검사 포함)
    - openNodes 메서드
    - deleteEntities 메서드 (관계 연쇄 삭제 포함)
    - 요구사항: 1.1, 1.2, 1.3, 1.5

  - [x] 4.3 엔티티 속성 테스트 작성
    - 속성 2: 엔티티 삭제 시 관계 연쇄 삭제
    - 속성 3: 중복 엔티티 이름 거부
    - 검증 대상: Requirements 1.3, 1.5, 2.4

  - [x] 4.4 관계 작업 구현
    - createRelations 메서드 (엔티티 존재 검증 포함)
    - deleteRelations 메서드
    - 요구사항: 2.1, 2.2, 2.3

  - [x] 4.5 관계 속성 테스트 작성
    - 속성 4: 관계 생성 및 조회
    - 속성 5: 관계는 존재하는 엔티티 필요
    - 속성 6: 관계 삭제는 선택적
    - 검증 대상: Requirements 2.1, 2.2, 2.3

- [x] 5. 체크포인트 - 핵심 기능 테스트
  - 모든 테스트가 통과하는지 확인
  - 질문이 있으면 사용자에게 문의

- [x] 6. 관찰 시스템 구현
  - [x] 6.1 관찰 작업 구현
    - addObservations 메서드 (엔티티 존재 검증 포함)
    - deleteObservations 메서드
    - 요구사항: 3.1, 3.2, 3.3

  - [x] 6.2 관찰 속성 테스트 작성
    - 속성 7: 관찰 내용 추가
    - 속성 8: 관찰 내용 삭제는 선택적
    - 속성 9: 관찰 내용은 존재하는 엔티티 필요
    - 검증 대상: Requirements 3.1, 3.2, 3.3

- [x] 7. 검색 및 조회 기능 구현
  - [x] 7.1 그래프 조회 및 검색 구현
    - readGraph 메서드
    - searchNodes 메서드 (이름, 타입, 관찰 내용 검색)
    - 요구사항: 4.1, 4.2

  - [x] 7.2 검색 속성 테스트 작성
    - 속성 10: 그래프 읽기는 모든 데이터 반환
    - 속성 11: 검색은 일치하는 엔티티 반환
    - 검증 대상: Requirements 4.1, 4.2, 4.3

  - [x] 7.3 검색 엣지 케이스 테스트
    - 빈 검색 결과 처리
    - 특수 문자 검색
    - 요구사항: 4.4

- [ ] 8. MCP 서버 계층 구현
  - [ ] 8.1 MCP 서버 초기화
    - MCP SDK를 사용한 서버 설정
    - 서버 시작 및 종료 로직
    - 요구사항: 6.1

  - [x] 8.2 MCP 도구 등록
    - 9개 도구 등록 (create_entities, create_relations, add_observations, delete_entities, delete_observations, delete_relations, read_graph, search_nodes, open_nodes)
    - 각 도구의 스키마 정의
    - 요구사항: 6.2

  - [ ] 8.3 도구 핸들러 구현
    - 각 도구를 KnowledgeGraphManager 메서드에 연결
    - 파라미터 검증 및 에러 처리
    - 응답 포맷팅 (MCP ToolResult 형식)
    - 요구사항: 6.3, 6.4

  - [ ] 8.4 MCP 도구 단위 테스트
    - 각 도구의 파라미터 검증 테스트
    - 에러 응답 형식 테스트
    - 요구사항: 6.4

- [ ] 9. 에러 처리 강화
  - [ ] 9.1 에러 메시지 개선
    - 설명적인 에러 메시지 작성
    - 한국어 설명 추가 (errorKo 필드)
    - 누락된 엔티티 이름 포함
    - 요구사항: 8.1, 8.2, 8.4

  - [ ] 9.2 에러 처리 속성 테스트
    - 속성 14: 잘못된 파라미터는 에러 반환
    - 속성 15: 누락된 엔티티 에러는 이름 포함
    - 검증 대상: Requirements 6.4, 8.2

  - [ ] 9.3 파일 시스템 에러 테스트
    - 파일 읽기/쓰기 실패 시나리오
    - 요구사항: 8.3

- [ ] 10. 동시성 제어 구현
  - [ ] 10.1 동시 접근 제어
    - 쓰기 작업 시 락(lock) 메커니즘 구현
    - 데이터 일관성 보장
    - 요구사항: 7.1, 7.2, 7.3

  - [ ] 10.2 동시성 속성 테스트
    - 속성 16: 동시 작업은 일관성 유지
    - 검증 대상: Requirements 7.1, 7.2, 7.3

- [ ] 11. 영속성 통합
  - [ ] 11.1 자동 저장 구현
    - 모든 수정 작업 후 자동 저장
    - 서버 시작 시 데이터 로드
    - 요구사항: 5.1, 5.2

  - [ ] 11.2 영속성 속성 테스트
    - 속성 13: 데이터는 재시작 후에도 유지
    - 검증 대상: Requirements 5.1, 5.2

- [ ] 12. 체크포인트 - 통합 테스트
  - 모든 테스트가 통과하는지 확인
  - 질문이 있으면 사용자에게 문의

- [ ] 13. CLI 진입점 및 실행 파일
  - [ ] 13.1 CLI 진입점 작성
    - bin/index.ts 작성 (서버 시작 로직)
    - 명령줄 인자 처리 (저장 경로 옵션)
    - 요구사항: 6.5

  - [ ] 13.2 빌드 및 패키징 설정
    - package.json bin 필드 설정
    - TypeScript 빌드 설정
    - npx 실행 테스트

- [ ] 14. 통합 테스트 작성
  - 전체 워크플로우 시나리오 테스트
  - MCP 프로토콜 준수 테스트
  - 요구사항: 6.1

- [ ] 15. 문서화
  - README.md 작성 (설치, 사용법, 예제)
  - API 문서 작성 (각 MCP 도구 설명)
  - 예제 코드 작성

- [ ] 16. 최종 체크포인트
  - 모든 테스트가 통과하는지 확인
  - 코드 품질 검토
  - 질문이 있으면 사용자에게 문의

## 참고사항

- 각 태스크는 특정 요구사항을 참조하여 추적 가능성을 보장합니다
- 체크포인트는 점진적 검증을 보장합니다
- 속성 테스트는 보편적 정확성 속성을 검증합니다
- 단위 테스트는 특정 예제 및 엣지 케이스를 검증합니다
